# GeoGig Web Server

## Running
Have a Java 8 JRE installed.

A fresh server start comes only with a precondifured `admin` user (pwd `g30g1g`) and a custom, very basic, for testing only, Authentication provider using Basic HTTP auth. It lets you create new users and set their passwords if logged in as an admin.

In the near future we'll integrated with more advanced authentication mechanisms. For the time being we're focused on the implementation of the API itself.

Being a Spring Boot application, the single-jar application is located at `target/geogig-server-<VERSION>.jar`.

The application needs to know where to store its configuration files. Currently it uses a very simple storage mechanism based on JSON files in a configuration directory, specified through the `DGEOGIG_SERVER_CONFIG_DIRECTORY` JVM System property or OS environment variable.

So either run

```
mkdir -p /data/geogig_web/config
export DGEOGIG_SERVER_CONFIG_DIRECTORY=/data/geogig_web/config
java -jar target/geogig-server-1.0-SNAPSHOT.jar
```

or

```
java -DGEOGIG_SERVER_CONFIG_DIRECTORY=/data/geogig_web/config -jar target/geogig-server-1.0-SNAPSHOT.jar
```

The default por where the web app runs is `8181`. Change it if desired though the `-Dserver.port` JVM argument.

Now open `http://localhost:8181/docs` in your browser to access the API documentation auto-generated by [Springfox](http://springfox.github.io/springfox/)  (`io.springfox:springfox-swagger2` and `io.springfox:springfox-swagger-ui`)

## Example usage with curl

### 1. Repository stores

First, create a repository store (make sure `data/geogig_web` or the parent directory you choose exists, tune the names and descriptions as well as the connection parameters as you wish):

```
curl -u admin:g30g1g -X POST --header 'Content-Type: application/json' --header 'Accept: application/json' -d '{
     "identity": "default_file_stores",
     "description": "Default repository store for file based repos",
     "enabled": true,
     "connectionInfo": {
       "type": "FileStoreInfo",
       "directory": "/data/geogig_web/default_file_stores"
     }
   }' 'http://localhost:8181/stores'
```

Or create a PostgreSQL repository store:

```
curl -u admin:g30g1g -X POST --header 'Content-Type: application/json' --header 'Accept: application/json' -d '{
     "identity": "postgres_store",
     "description": "Default postgresql",
     "enabled": true,
     "connectionInfo": {
       "type": "PostgresStoreInfo",
       "server": "localhost",
       "port": 5432,
       "database": "geogig_web",
       "schema": "public", 
       "user": "postgres",
       "password": "geo123"
     } 
 }' 'http://localhost:8181/stores'
```
### 2. Users

Create a new (non site admin) user:

```
curl -u admin:g30g1g -X POST --header 'Content-Type: application/json' --header 'Accept: application/json' -d '{
     "identity": "demouser", 
     "type": "INDIVIDUAL", 
     "siteAdmin": false, 
     "privateProfile": { 
       "fullName": "Gabriel Roldan",
       "emailAddress": "demouser@example.com",
       "location": "Rosario, Santa Fe, Argentina",
       "defaultStore": {
         "identity": "postgres_store"
      }
    } 
 }' 'http://localhost:8181/users'
```

And assign him the password `s3cr3t`:

```
curl -v -u admin:g30g1g -X PUT --header 'Content-Type: application/json' -d 's3cr3t' 'http://localhost:8181/users/demouser/password'
< HTTP/1.1 204 No Content
```

### 3. Repositories

Now we'll authenticate as the newly created user and create a repository:

```
curl -v -u demouser:s3cr3t -X POST --header 'Accept: application/json' 'http://localhost:8181/repos/demouser/demoRepo'
< HTTP/1.1 201 Created
{"id":"4d014cdd-e2f9-4888-9771-95b643418579","identity":"demoRepo2","store":{"id":"a6307ffb-2a3b-441a-8cd0-92e6e981f1bf","identity":"postgres_store"},"owner":{"id":"97c0a0ea-1cea-422a-b3c5-85794306107c","identity":"demouser"}}
```

### 4. Feature Service

Finally, lets use the repository's "Feature Service" to interact with it as a regular GIS client would most of the time when editing data.

#### I. Start a transaction

All the operations in the feature service that change the state of the repository require a transaction.
Run the following to start a transaction, and take note of the returned transaction id (in this case `7cb5fbbf-d8ec-410a-8a12-b78639e0e88a`):

```
curl -v -u demouser:s3cr3t -X POST --header 'Accept: application/json' 'http://localhost:8181/transactions/demouser/demoRepo'
< HTTP/1.1 201 Created
{
  "id":"7cb5fbbf-d8ec-410a-8a12-b78639e0e88a",
  "status":"OPEN",
  "created-at":1517536289.419000000,
  "created-by":{
    "id":"13ac76e1-e454-4de8-952d-6f640abd479a",
    "identity":"demouser",
    "type":"INDIVIDUAL", ....
  },
  "repository":{
    "id":"10d1f606-f581-4808-b735-b4cd5e9eff0c",
    "identity":"demoRepo",
    "store":{
      "id":"a6307ffb-2a3b-441a-8cd0-92e6e981f1bf","
      identity":"postgres_store"
    },
    "owner":{
      "id":"13ac76e1-e454-4de8-952d-6f640abd479a",
      "identity":"demouser"
    }
  }
}
```

#### II. Create a "Layer"

From the point of view of the feature service, a Layer is the tipycal collection of Features of an homogeneus FeatureType. In a geogig repository, a layer maps directly to a "feature tree". That is, a Tree in the revision graph that's a direct child of a root tree (like the ones pointed out to by commits).

Note bellow we're using the created transaction id as the `--header 'geogig-transaction-id: 7cb5fbbf-d8ec-410a-8a12-b78639e0e88a'` parameter.

```
curl -v -u demouser:s3cr3t -X POST --header 'Content-Type: application/json' --header 'Accept: application/json' --header 'geogig-transaction-id: 7cb5fbbf-d8ec-410a-8a12-b78639e0e88a' -d '{ 
       "objectType": "RevisionFeatureType",
       "name": "Poi", 
       "properties": [
         { 
           "name": "location", 
           "binding": "POINT", 
           "crs": { 
             "authorityCode": "EPSG:4326" 
           } 
         }, 
         { 
           "name": "name", 
           "binding": "STRING" 
         } 
       ] 
 }' 'http://localhost:8181/layers/demouser/demoRepo'
```
The above command creates a layer named `Poi` with two attribute properties: `location` of type `POINT` and `name` of type `STRING`.

We could commit the transaction right here, but for the sake of the exercise we'll continue doing work inside the same transaction.

Note if we query the layer without the transaction id as parameter we'll get a `404`:

```
curl -v -u demouser:s3cr3t  'http://localhost:8181/layers/demouser/demoRepo/Poi'
< HTTP/1.1 404 Not Found
```
Hence we need to keep working inside the transaction:

```
curl -v -u demouser:s3cr3t --header 'geogig-transaction-id: 7cb5fbbf-d8ec-410a-8a12-b78639e0e88a' 'http://localhost:8181/layers/demouser/demoRepo/Poi'
< HTTP/1.1 200 OK
{
   "name" : "Poi",
   "title" : null,
   "abstract" : null,
   "size" : 0,
   "bounds" : [],
   "type" : {
      "objectType" : "RevisionFeatureType",
      "id" : "28f3259487d79a181e972986d34fd8ccd1091c6e",
      "name" : "Poi",
      "defaultGeometry" : "location",
      "properties" : [
        ...
      ]
   }
}
```

#### III. Access Features
A layer's features are retrieved at the `/layers/:user/:repo/:layer/features` endpoint. The default output format is GeoJSON (optionally binary encoded).

```
curl -v -u demouser:s3cr3t -X GET --header 'Accept: application/vnd.geo+json' --header 'geogig-transaction-id: 7cb5fbbf-d8ec-410a-8a12-b78639e0e88a' 'http://localhost:8181/layers/demouser/demoRepo/Poi/features'
< HTTP/1.1 200 OK
< Content-Type: application/vnd.geo+json
{
   "type" : "FeatureCollection",
   "featureType" : {
      "properties" : [
         {
            "name" : "location", "nillable" : true, "binding" : "POINT", "crs" : {"authorityCode" : "EPSG:4326"}
         },
         {
            "name" : "name", "nillable" : true, "binding" : "STRING"
         }
      ],
      "objectType" : "RevisionFeatureType",
      "defaultGeometry" : "location",
      "name" : "Poi",
      "id" : null
   },
   "crs" : {
      "type" : "name",
      "properties" : {
         "name" : "EPSG:4326"
      }
   },
   "features" : []
}
```

Note the returned `features` array is empty and most notably, we're adding a custom (that's not part of the GeoJSON spec) `featureType` attribute to the resturned FeatureCollection. This is so smart clients can take advantage of the more specific attribute type information provided by the feature type than JSON can provide. Also, when streaming featues from this endpoint, the `featureTpe` object will always come before the `features` array.

#### IV. Add Features
Now, lets add some features to the `Poi` layer.
First method is to post a FeatureCollection to the layer's features collection in order to insert several features at once:

```
curl -v -u demouser:s3cr3t -X POST --header 'Content-Type: application/vnd.geo+json' --header 'Accept: application/json' --header 'geogig-transaction-id: 7cb5fbbf-d8ec-410a-8a12-b78639e0e88a' -d '{
   "type" : "FeatureCollection",
   "crs" : {
      "type" : "name",
      "properties" : {
         "name" : "EPSG:4326"
      }
   },
   "features" : [
      {
         "type" : "Feature",
         "geometry" : {
            "type" : "Point",
            "coordinates" : [
               175.62128328,
               -40.32331789
            ]
         },
         "properties" : {
            "name" : "Palmerston N. Int`l"
         }
      },
      {
         "type" : "Feature",
         "geometry" : {
            "type" : "Point",
            "coordinates" : [
               23.5721092,
               -6.12484541
            ]
         },
         "properties" : {
            "name" : "Mbuji Mayi"
         }
      }
   ]
}' 'http://localhost:8181/layers/demouser/demoRepo/Poi/features'
> POST /layers/demouser/demoRepo/Poi/features HTTP/1.1
> Content-Type: application/vnd.geo+json
> geogig-transaction-id: 7cb5fbbf-d8ec-410a-8a12-b78639e0e88a
* upload completely sent off: 734 out of 734 bytes
< HTTP/1.1 204 No Content
```

Note in the above example we haven't included our custom `featureType` property in the GeoJSON FeatureCollection on purpose to show that it'd work nonetheless, but it's included it won't hurt.

Alternatively, you can send one single feature to this endpoint (it receives a `Feature` object, and `FeatureCollection` extends `Feature` in the object model):

```
curl -v -u demouser:s3cr3t -X POST --header 'Content-Type: application/vnd.geo+json' --header 'Accept: application/json' --header 'geogig-transaction-id: 7cb5fbbf-d8ec-410a-8a12-b78639e0e88a' -d '{
 "type" : "Feature",
 "properties" : {
    "name" : "Rio de Janeiro-Antonio Carlos Jobim Int`l"
 },
 "geometry" : {
    "coordinates" : [
       -43.2483813790683,
       -22.8123437125006
    ],
    "type" : "Point"
 }
}' 'http://localhost:8181/layers/demouser/demoRepo/Poi/features'
> POST /layers/demouser/demoRepo/Poi/features HTTP/1.1
> Content-Type: application/vnd.geo+json
> geogig-transaction-id: 7cb5fbbf-d8ec-410a-8a12-b78639e0e88a
* upload completely sent off: 263 out of 263 bytes
< HTTP/1.1 204 No Content
```


Now re-run the features query to verify the features have been added:

```
curl -v -u demouser:s3cr3t --header 'Accept: application/vnd.geo+json' --header 'geogig-transaction-id: 7cb5fbbf-d8ec-410a-8a12-b78639e0e88a' 'http://localhost:8181/layers/demouser/demoRepo/Poi/features'
> GET /layers/demouser/demoRepo/Poi/features HTTP/1.1
> Accept: application/vnd.geo+json
> geogig-transaction-id: 7cb5fbbf-d8ec-410a-8a12-b78639e0e88a
> 
< HTTP/1.1 200 OK
< Content-Type: application/vnd.geo+json
{
   "type" : "FeatureCollection",
   "featureType" : {
      "objectType" : "RevisionFeatureType",
      "name" : "Poi",
      "defaultGeometry" : "location",
      "properties" : [
         {
            "name" : "location",
            "binding" : "POINT",
            "nillable" : true,
            "crs" : {
               "authorityCode" : "EPSG:4326"
            }
         },
         {
            "name" : "name",
            "binding" : "STRING",
            "nillable" : true
         }
      ]
   },
   "crs" : {
      "type" : "name",
      "properties" : {
         "name" : "EPSG:4326"
      }
   },
   "features" : [
      {
         "type" : "Feature",
         "id" : "a34e992b9",
         "properties" : {
            "name" : "Palmerston N. Int`l"
         },
         "geometry" : {
            "coordinates" : [
               175.62128328,
               -40.32331789
            ],
            "type" : "Point",
            "name" : "location"
         }
      },
      {
         "type" : "Feature",
         "id" : "a34e992b10",
         "properties" : {
            "name" : "Mbuji Mayi"
         },
         "geometry" : {
            "name" : "location",
            "type" : "Point",
            "coordinates" : [
               23.5721092,
               -6.12484541
            ]
         }
      },
      {
         "type" : "Feature",
         "id" : "b67a8a2811"
         "properties" : {
            "name" : "Rio de Janeiro-Antonio Carlos Jobim Int`l"
         },
         "geometry" : {
            "type" : "Point",
            "coordinates" : [
               -43.2483813790683,
               -22.8123437125006
            ],
            "name" : "location"
         }
      }
   ]
}
```

####  Commit transaction

```
curl -v -u demouser:s3cr3t -X POST --header 'Content-Type: application/json' --header 'Accept: application/json' --header 'messageTitle: Inserted three points as demo' 'http://localhost:8181/transactions/demouser/demoRepo/7cb5fbbf-d8ec-410a-8a12-b78639e0e88a/commit'
< HTTP/1.1 200 OK
{
   "id" : "4267b8fc-ec0e-4aa1-b34f-19d2237a9157",
   "status" : "COMPLETE",
   "scheduled_at" : 1517949258.176,
   "last_updated" : 1517949258.223,
   "finished_at" : 1517949258.223,
   "started_by" : {
      "id" : "13ac76e1-e454-4de8-952d-6f640abd479a",
      "identity" : "demouser",
      "type" : "INDIVIDUAL",
      "siteAdmin" : false
   },
   "transaction" : {
      "id" : "7cb5fbbf-d8ec-410a-8a12-b78639e0e88a",
      "status" : "COMMITTED",
      "created-at" : 1517940602.902,
      "repository" : {
         "id" : "10d1f606-f581-4808-b735-b4cd5e9eff0c",
         "identity" : "demoRepo",
         "owner" : {
            "id" : "13ac76e1-e454-4de8-952d-6f640abd479a",
            "identity" : "demouser"
         },
         "store" : {
            "identity" : "postgres_store",
            "id" : "a6307ffb-2a3b-441a-8cd0-92e6e981f1bf"
         }
      },
      "created-by" : {
         "id" : "13ac76e1-e454-4de8-952d-6f640abd479a",
         "identity" : "demouser",
         "siteAdmin" : false,
         "type" : "INDIVIDUAL"
      }
   }
}
```

## JSON Serialization

Some aspects of JSON serialization are configured in `application.properties`.

Another way of doing so would be by providing a `@bean` of type `Jackson2ObjectMapperBuilder`.

* `null` values are omitted in JSON response entities by setting `spring.jackson.default-property-inclusion=non_absent`
* Date formatting:

```
spring.jackson.date-format=org.locationtech.geogig.web.configuration.RFC3339DateFormat
spring.jackson.serialization.WRITE_DATES_AS_TIMESTAMPS=false
```

See [howto-customize-the-jackson-objectmapper](https://docs.spring.io/spring-boot/docs/current-SNAPSHOT/reference/htmlsingle/#howto-customize-the-jackson-objectmapper) for more options.